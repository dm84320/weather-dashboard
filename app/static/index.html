<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .container {
            max-width: 1200px;
        }

        h1 {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .search-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .input-group {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .form-control {
            border: none;
            padding: 15px;
            font-size: 1.1rem;
        }

        .form-control:focus {
            box-shadow: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            border: none;
            padding: 15px 30px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #map {
            height: 300px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .weather-card {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .weather-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .weather-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .card-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .weather-detail {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .weather-detail:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateX(5px);
        }

        .weather-detail i {
            margin-right: 15px;
            width: 25px;
            font-size: 1.2rem;
        }

        .forecast-card {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .forecast-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .forecast-icon {
            font-size: 2.5rem;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .source-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
        }

        .temperature {
            font-size: 2.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 20px 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
            margin: 20px 0;
        }

        .search-history {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateX(5px);
        }

        .favorite-btn {
            background: none;
            border: none;
            color: #ffd700;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .favorite-btn:hover {
            transform: scale(1.2);
        }

        .unit-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .unit-toggle button {
            background: none;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: 500;
            color: #2c3e50;
        }

        .unit-toggle button.active {
            color: #4b6cb7;
            font-weight: 600;
        }

        .weather-alert {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            display: none;
        }

        .weather-alert.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .favorites-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .favorite-city {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .favorite-city:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .weather-trends {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .trend-chart {
            height: 200px;
            margin: 20px 0;
        }

        .air-quality {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            margin: 10px 0;
        }

        .air-quality-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
        }

        .sun-times {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            margin: 10px 0;
        }

        .sun-time {
            text-align: center;
        }

        .sun-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .city-comparison {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .activity-suggestions {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .activity-card {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .activity-card:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.8);
        }

        .activity-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .compare-btn {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .compare-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .clothing-suggestions {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .clothing-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .clothing-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.8);
        }

        .clothing-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .uv-index {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .uv-meter {
            height: 20px;
            background: linear-gradient(to right, #00ff00, #ffff00, #ff0000);
            border-radius: 10px;
            margin: 15px 0;
            position: relative;
        }

        .uv-indicator {
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid #333;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            transition: left 0.3s ease;
        }

        .weather-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .weather-widget {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .weather-widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .widget-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .notification-bell {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-bell:hover {
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .modal {
            background: rgba(0, 0, 0, 0.5);
        }
        .modal-dialog {
            margin: 1.75rem auto;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }
        .modal-body {
            padding: 1rem;
        }
        .alert {
            border-radius: 10px;
            padding: 1rem;
        }
        .alert-info {
            background: rgba(52, 152, 219, 0.1);
            border-color: #3498db;
        }
        .alert-warning {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="notification-bell" onclick="toggleNotifications()">
        <i class="bi bi-bell"></i>
        <span class="notification-badge" id="notificationCount">0</span>
    </div>

    <div class="container">
        <h1 class="text-center">Weather Dashboard</h1>
        
        <div class="unit-toggle">
            <button onclick="toggleUnit('celsius')" class="active">°C</button>
            <button onclick="toggleUnit('fahrenheit')">°F</button>
        </div>

        <div class="weather-alert" id="weatherAlert"></div>
        
        <div class="search-container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" id="cityInput" class="form-control" placeholder="Enter city name...">
                        <button class="btn btn-primary" onclick="getWeather()">Get Weather</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="favorites-container">
            <h5 class="mb-3">Favorite Cities</h5>
            <div id="favoriteCities"></div>
        </div>

        <div class="search-history">
            <h5 class="mb-3">Recent Searches</h5>
            <div id="searchHistory"></div>
        </div>

        <div class="loading">
            <div class="loading-spinner"></div>
            <p class="mt-3">Loading weather data...</p>
        </div>

        <div class="error-message"></div>

        <div id="map"></div>
        <div id="weatherResults" class="row"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map = null;
        let marker = null;
        let currentUnit = 'celsius';
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];
        let favoriteCities = JSON.parse(localStorage.getItem('favoriteCities')) || [];

        // Initialize the UI
        function initializeUI() {
            updateSearchHistory();
            updateFavoriteCities();
        }

        // Temperature conversion
        function convertTemperature(temp, unit) {
            if (unit === 'fahrenheit') {
                return (temp * 9/5) + 32;
            }
            return temp;
        }

        // Toggle temperature unit
        function toggleUnit(unit) {
            currentUnit = unit;
            document.querySelectorAll('.unit-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.unit-toggle button[onclick="toggleUnit('${unit}')"]`).classList.add('active');
            
            // Update displayed temperatures
            const temps = document.querySelectorAll('.temperature');
            temps.forEach(temp => {
                const celsius = parseFloat(temp.getAttribute('data-celsius'));
                const converted = convertTemperature(celsius, unit);
                temp.textContent = `${converted.toFixed(1)}°${unit === 'celsius' ? 'C' : 'F'}`;
            });
        }

        // Update search history
        function updateSearchHistory() {
            const historyContainer = document.getElementById('searchHistory');
            historyContainer.innerHTML = searchHistory
                .slice(-5)
                .reverse()
                .map(city => `
                    <div class="history-item" onclick="searchCity('${city}')">
                        <span>${city}</span>
                        <button class="favorite-btn" onclick="toggleFavorite('${city}', event)">
                            <i class="bi bi-star${favoriteCities.includes(city) ? '-fill' : ''}"></i>
                        </button>
                    </div>
                `).join('');
        }

        // Update favorite cities
        function updateFavoriteCities() {
            const favoritesContainer = document.getElementById('favoriteCities');
            favoritesContainer.innerHTML = favoriteCities
                .map(city => `
                    <span class="favorite-city" onclick="searchCity('${city}')">
                        ${city}
                        <button class="favorite-btn" onclick="toggleFavorite('${city}', event)">
                            <i class="bi bi-star-fill"></i>
                        </button>
                    </span>
                `).join('');
        }

        // Toggle favorite city
        function toggleFavorite(city, event) {
            event.stopPropagation();
            const index = favoriteCities.indexOf(city);
            if (index === -1) {
                favoriteCities.push(city);
            } else {
                favoriteCities.splice(index, 1);
            }
            localStorage.setItem('favoriteCities', JSON.stringify(favoriteCities));
            updateSearchHistory();
            updateFavoriteCities();
        }

        // Search city
        function searchCity(city) {
            document.getElementById('cityInput').value = city;
            getWeather();
        }

        // Show weather alert
        function showWeatherAlert(message) {
            const alert = document.getElementById('weatherAlert');
            alert.textContent = message;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function initMap(lat, lon) {
            if (map) {
                map.remove();
            }
            map = L.map('map').setView([lat, lon], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lon]).addTo(map);
        }

        function showLoading() {
            document.querySelector('.loading').style.display = 'block';
            document.querySelector('.error-message').style.display = 'none';
        }

        function hideLoading() {
            document.querySelector('.loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.querySelector('.error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function getAirQualityColor(aqi) {
            if (aqi <= 50) return '#00e400';
            if (aqi <= 100) return '#ffff00';
            if (aqi <= 150) return '#ff7e00';
            if (aqi <= 200) return '#ff0000';
            if (aqi <= 300) return '#99004c';
            return '#7e0023';
        }

        function getAirQualityDescription(aqi) {
            if (aqi <= 50) return 'Good';
            if (aqi <= 100) return 'Moderate';
            if (aqi <= 150) return 'Unhealthy for Sensitive Groups';
            if (aqi <= 200) return 'Unhealthy';
            if (aqi <= 300) return 'Very Unhealthy';
            return 'Hazardous';
        }

        function getActivitySuggestions(weather) {
            const suggestions = [];
            const temp = weather.temperature;
            const condition = weather.description.toLowerCase();

            if (temp > 25 && !condition.includes('rain')) {
                suggestions.push({
                    icon: '🏊',
                    activity: 'Swimming',
                    description: 'Perfect weather for a swim!'
                });
            }
            if (temp > 20 && temp < 30 && !condition.includes('rain')) {
                suggestions.push({
                    icon: '🚶',
                    activity: 'Hiking',
                    description: 'Great conditions for a hike!'
                });
            }
            if (temp < 15) {
                suggestions.push({
                    icon: '☕',
                    activity: 'Hot Drinks',
                    description: 'Perfect weather for a warm beverage!'
                });
            }
            if (condition.includes('rain')) {
                suggestions.push({
                    icon: '🎮',
                    activity: 'Indoor Activities',
                    description: 'Stay dry with indoor activities!'
                });
            }
            if (weather.wind_speed < 10) {
                suggestions.push({
                    icon: '🚴',
                    activity: 'Cycling',
                    description: 'Light winds make for great cycling!'
                });
            }

            return suggestions;
        }

        function getUVIndexColor(uv) {
            if (uv <= 2) return '#00ff00';
            if (uv <= 5) return '#ffff00';
            if (uv <= 7) return '#ff7e00';
            if (uv <= 10) return '#ff0000';
            return '#99004c';
        }

        function getUVIndexDescription(uv) {
            if (uv <= 2) return 'Low - No protection needed';
            if (uv <= 5) return 'Moderate - Some protection needed';
            if (uv <= 7) return 'High - Protection essential';
            if (uv <= 10) return 'Very High - Extra protection needed';
            return 'Extreme - Avoid sun exposure';
        }

        function getClothingSuggestions(weather) {
            const suggestions = [];
            const temp = weather.temperature;
            const condition = weather.description.toLowerCase();

            if (temp < 10) {
                suggestions.push({
                    icon: '🧥',
                    item: 'Heavy Coat',
                    description: 'Wear a warm, insulated coat'
                });
                suggestions.push({
                    icon: '🧤',
                    item: 'Gloves',
                    description: 'Protect your hands from the cold'
                });
            } else if (temp < 15) {
                suggestions.push({
                    icon: '🧥',
                    item: 'Light Jacket',
                    description: 'A light jacket will keep you comfortable'
                });
            } else if (temp < 20) {
                suggestions.push({
                    icon: '🧥',
                    item: 'Sweater',
                    description: 'A light sweater should be enough'
                });
            } else if (temp < 25) {
                suggestions.push({
                    icon: '👕',
                    item: 'Long Sleeves',
                    description: 'Light long sleeves are recommended'
                });
            } else {
                suggestions.push({
                    icon: '👕',
                    item: 'Short Sleeves',
                    description: 'Short sleeves are perfect for this weather'
                });
            }

            if (condition.includes('rain')) {
                suggestions.push({
                    icon: '🌂',
                    item: 'Umbrella',
                    description: 'Don\'t forget your umbrella!'
                });
                suggestions.push({
                    icon: '👢',
                    item: 'Waterproof Shoes',
                    description: 'Keep your feet dry'
                });
            }

            return suggestions;
        }

        function updateWeatherWidgets(weather) {
            const widgets = document.createElement('div');
            widgets.className = 'weather-widgets';
            widgets.innerHTML = `
                <div class="weather-widget" onclick="showDetailedForecast()">
                    <div class="widget-icon">📅</div>
                    <h5>7-Day Forecast</h5>
                </div>
                <div class="weather-widget" onclick="showHistoricalData()">
                    <div class="widget-icon">📊</div>
                    <h5>Historical Data</h5>
                </div>
                <div class="weather-widget" onclick="showWeatherMap()">
                    <div class="widget-icon">🗺️</div>
                    <h5>Weather Map</h5>
                </div>
                <div class="weather-widget" onclick="showWeatherAlerts()">
                    <div class="widget-icon">⚠️</div>
                    <h5>Weather Alerts</h5>
                </div>
            `;
            document.getElementById('weatherResults').appendChild(widgets);
        }

        // Widget Functions
        async function showDetailedForecast() {
            const city = document.getElementById('cityInput').value;
            if (!city) {
                showError('Please enter a city name first');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/weather/current?city=${encodeURIComponent(city)}`);
                const data = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">7-Day Forecast for ${city}</h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    ${Array(7).fill(null).map((_, i) => {
                                        const date = new Date();
                                        date.setDate(date.getDate() + i);
                                        return `
                                            <div class="col-md-4 mb-3">
                                                <div class="forecast-card">
                                                    <h5>${date.toLocaleDateString()}</h5>
                                                    <div class="forecast-icon">${data.current.icon}</div>
                                                    <div class="temperature" data-celsius="${data.current.temperature + (i * 2)}">
                                                        ${convertTemperature(data.current.temperature + (i * 2), currentUnit).toFixed(1)}°${currentUnit === 'celsius' ? 'C' : 'F'}
                                                    </div>
                                                    <p>${data.current.description}</p>
                                                    <div class="weather-details">
                                                        <div class="weather-detail">
                                                            <i>💧</i> ${data.current.humidity}%
                                                        </div>
                                                        <div class="weather-detail">
                                                            <i>💨</i> ${data.current.wind_speed} m/s
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                hideLoading();
            } catch (error) {
                console.error('Error fetching forecast:', error);
                showError('Error fetching forecast data');
                hideLoading();
            }
        }

        async function showHistoricalData() {
            const city = document.getElementById('cityInput').value;
            if (!city) {
                showError('Please enter a city name first');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/weather/historical?city=${encodeURIComponent(city)}`);
                const data = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Historical Weather Data for ${city}</h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Temperature</th>
                                                <th>Humidity</th>
                                                <th>Wind Speed</th>
                                                <th>Conditions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.map(record => `
                                                <tr>
                                                    <td>${new Date(record.timestamp).toLocaleString()}</td>
                                                    <td>${convertTemperature(record.temperature, currentUnit).toFixed(1)}°${currentUnit === 'celsius' ? 'C' : 'F'}</td>
                                                    <td>${record.humidity}%</td>
                                                    <td>${record.wind_speed} m/s</td>
                                                    <td>${record.description}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                hideLoading();
            } catch (error) {
                console.error('Error fetching historical data:', error);
                showError('Error fetching historical data');
                hideLoading();
            }
        }

        async function showWeatherMap() {
            const city = document.getElementById('cityInput').value;
            if (!city) {
                showError('Please enter a city name first');
                return;
            }

            showLoading();
            try {
                // Get current weather data to get coordinates
                const response = await fetch(`/api/weather/current?city=${encodeURIComponent(city)}`);
                const data = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Weather Map - ${city}</h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                <div id="weatherMap" style="height: 500px;"></div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Initialize map in the modal with the city's coordinates
                const weatherMap = L.map('weatherMap').setView([data.current.latitude, data.current.longitude], 10);
                
                // Add base map layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(weatherMap);

                // Add marker for the city
                const marker = L.marker([data.current.latitude, data.current.longitude]).addTo(weatherMap);
                marker.bindPopup(`<b>${city}</b><br>Temperature: ${convertTemperature(data.current.temperature, currentUnit).toFixed(1)}°${currentUnit === 'celsius' ? 'C' : 'F'}<br>Conditions: ${data.current.description}`).openPopup();

                // Add temperature layer (simulated)
                const tempLayer = L.tileLayer('https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=YOUR_API_KEY', {
                    opacity: 0.5
                }).addTo(weatherMap);

                // Add layer control
                const baseMaps = {
                    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    })
                };

                const overlayMaps = {
                    "Temperature": tempLayer
                };

                L.control.layers(baseMaps, overlayMaps).addTo(weatherMap);

                hideLoading();
            } catch (error) {
                console.error('Error showing weather map:', error);
                showError('Error loading weather map');
                hideLoading();
            }
        }

        function showWeatherAlerts() {
            const city = document.getElementById('cityInput').value;
            if (!city) {
                showError('Please enter a city name first');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Weather Alerts for ${city}</h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert-list">
                                ${notifications.map(notification => `
                                    <div class="alert alert-${notification.type} mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">${notification.message}</h6>
                                                <small>${new Date(notification.timestamp).toLocaleString()}</small>
                                            </div>
                                            <button class="btn btn-sm btn-outline-${notification.type}" onclick="this.closest('.alert').remove()">
                                                Dismiss
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        let notifications = [];
        let notificationCount = 0;

        function addNotification(message, type = 'info') {
            notifications.push({ message, type, timestamp: new Date() });
            notificationCount++;
            document.getElementById('notificationCount').textContent = notificationCount;
        }

        function toggleNotifications() {
            const notificationList = document.createElement('div');
            notificationList.className = 'notification-list';
            notificationList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.type}">
                    <p>${notification.message}</p>
                    <small>${new Date(notification.timestamp).toLocaleTimeString()}</small>
                </div>
            `).join('');
            // Show notification list in a modal or dropdown
        }

        async function getWeather() {
            const city = document.getElementById('cityInput').value;
            if (!city) {
                showError('Please enter a city name');
                return;
            }

            // Add to search history
            if (!searchHistory.includes(city)) {
                searchHistory.push(city);
                if (searchHistory.length > 10) searchHistory.shift();
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                updateSearchHistory();
            }

            showLoading();
            try {
                const response = await fetch(`/api/weather/current?city=${encodeURIComponent(city)}`);
                const data = await response.json();
                displayWeather(data);
                hideLoading();
            } catch (error) {
                console.error('Error fetching weather data:', error);
                showError('Error fetching weather data. Please try again.');
                hideLoading();
            }
        }

        async function displayWeather(weatherData) {
            const container = document.getElementById('weatherResults');
            container.innerHTML = '';

            const data = weatherData.current;
            const forecast = weatherData.forecast;

            // Initialize map
            initMap(data.latitude, data.longitude);

            // Check for weather alerts
            if (data.temperature > 30) {
                showWeatherAlert('High temperature alert! Stay hydrated and avoid prolonged sun exposure.');
            } else if (data.temperature < 5) {
                showWeatherAlert('Low temperature alert! Dress warmly and be cautious of icy conditions.');
            }

            // Current weather card
            const currentCard = document.createElement('div');
            currentCard.className = 'col-md-6 mb-4';
            currentCard.innerHTML = `
                <div class="card weather-card">
                    <div class="card-body p-4">
                        <span class="badge source-badge">${data.source}</span>
                        <button class="favorite-btn" onclick="toggleFavorite('${data.location}', event)">
                            <i class="bi bi-star${favoriteCities.includes(data.location) ? '-fill' : ''}"></i>
                        </button>
                        <div class="weather-icon text-center">${data.icon}</div>
                        <h3 class="card-title text-center">${data.location}</h3>
                        <div class="temperature text-center" data-celsius="${data.temperature}">
                            ${convertTemperature(data.temperature, currentUnit).toFixed(1)}°${currentUnit === 'celsius' ? 'C' : 'F'}
                        </div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <i>💧</i> Humidity: ${data.humidity}%
                            </div>
                            <div class="weather-detail">
                                <i>💨</i> Wind Speed: ${data.wind_speed} m/s
                            </div>
                            <div class="weather-detail">
                                <i>🌧️</i> Precipitation: ${data.precipitation} mm
                            </div>
                            <div class="weather-detail">
                                <i>🌡️</i> Pressure: ${data.pressure} hPa
                            </div>
                            <div class="weather-detail">
                                <i>☁️</i> Conditions: ${data.description}
                            </div>
                        </div>
                        <small class="text-muted d-block mt-4">Last updated: ${new Date(data.timestamp).toLocaleString()}</small>
                    </div>
                </div>
            `;
            container.appendChild(currentCard);

            // Air Quality Section
            const airQualityCard = document.createElement('div');
            airQualityCard.className = 'col-md-6 mb-4';
            const aqi = Math.floor(Math.random() * 200); // Simulated AQI
            airQualityCard.innerHTML = `
                <div class="card weather-card">
                    <div class="card-body p-4">
                        <h4 class="card-title">Air Quality</h4>
                        <div class="air-quality">
                            <div class="air-quality-indicator" style="background-color: ${getAirQualityColor(aqi)}"></div>
                            <div>
                                <h5>AQI: ${aqi}</h5>
                                <p class="mb-0">${getAirQualityDescription(aqi)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(airQualityCard);

            // Sun Times Section
            const sunTimesCard = document.createElement('div');
            sunTimesCard.className = 'col-md-6 mb-4';
            const sunrise = new Date();
            sunrise.setHours(6, 0, 0);
            const sunset = new Date();
            sunset.setHours(20, 0, 0);
            sunTimesCard.innerHTML = `
                <div class="card weather-card">
                    <div class="card-body p-4">
                        <h4 class="card-title">Sun Times</h4>
                        <div class="sun-times">
                            <div class="sun-time">
                                <div class="sun-icon">🌅</div>
                                <div>Sunrise</div>
                                <div>${sunrise.toLocaleTimeString()}</div>
                            </div>
                            <div class="sun-time">
                                <div class="sun-icon">🌇</div>
                                <div>Sunset</div>
                                <div>${sunset.toLocaleTimeString()}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(sunTimesCard);

            // Activity Suggestions
            const activityCard = document.createElement('div');
            activityCard.className = 'col-md-6 mb-4';
            const suggestions = getActivitySuggestions(data);
            activityCard.innerHTML = `
                <div class="card weather-card">
                    <div class="card-body p-4">
                        <h4 class="card-title">Suggested Activities</h4>
                        ${suggestions.map(suggestion => `
                            <div class="activity-card">
                                <div class="d-flex align-items-center">
                                    <span class="activity-icon">${suggestion.icon}</span>
                                    <div>
                                        <h5 class="mb-1">${suggestion.activity}</h5>
                                        <p class="mb-0">${suggestion.description}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            container.appendChild(activityCard);

            // Forecast cards
            const forecastCard = document.createElement('div');
            forecastCard.className = 'col-md-12';
            forecastCard.innerHTML = `
                <h3 class="mb-4">3-Day Forecast</h3>
                <div class="row">
                    ${forecast.map(day => `
                        <div class="col-md-4">
                            <div class="forecast-card">
                                <div class="forecast-icon">${day.icon}</div>
                                <h5>${new Date(day.date).toLocaleDateString()}</h5>
                                <div class="temperature" data-celsius="${day.temperature}">
                                    ${convertTemperature(day.temperature, currentUnit).toFixed(1)}°${currentUnit === 'celsius' ? 'C' : 'F'}
                                </div>
                                <p class="mb-2">${day.description}</p>
                                <div class="weather-details">
                                    <div class="weather-detail">
                                        <i>💧</i> ${day.humidity}%
                                    </div>
                                    <div class="weather-detail">
                                        <i>💨</i> ${day.wind_speed} m/s
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(forecastCard);

            // City Comparison Section
            const comparisonCard = document.createElement('div');
            comparisonCard.className = 'col-md-12 mt-4';
            comparisonCard.innerHTML = `
                <div class="city-comparison">
                    <h4 class="mb-3">Compare with Another City</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="compareCity" placeholder="Enter city to compare">
                        </div>
                        <div class="col-md-6">
                            <button class="compare-btn" onclick="compareCities('${data.location}')">Compare</button>
                        </div>
                    </div>
                    <div id="comparisonResults" class="mt-4"></div>
                </div>
            `;
            container.appendChild(comparisonCard);

            // Add UV Index Section
            const uvCard = document.createElement('div');
            uvCard.className = 'col-md-6 mb-4';
            const uvIndex = Math.floor(Math.random() * 11); // Simulated UV index
            uvCard.innerHTML = `
                <div class="card weather-card">
                    <div class="card-body p-4">
                        <h4 class="card-title">UV Index</h4>
                        <div class="uv-meter">
                            <div class="uv-indicator" style="left: ${(uvIndex / 11) * 100}%"></div>
                        </div>
                        <div class="text-center">
                            <h5>${uvIndex}</h5>
                            <p>${getUVIndexDescription(uvIndex)}</p>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(uvCard);

            // Add Clothing Suggestions
            const clothingCard = document.createElement('div');
            clothingCard.className = 'col-md-6 mb-4';
            const clothingSuggestions = getClothingSuggestions(data);
            clothingCard.innerHTML = `
                <div class="card weather-card">
                    <div class="card-body p-4">
                        <h4 class="card-title">What to Wear</h4>
                        ${clothingSuggestions.map(suggestion => `
                            <div class="clothing-item">
                                <span class="clothing-icon">${suggestion.icon}</span>
                                <div>
                                    <h5 class="mb-1">${suggestion.item}</h5>
                                    <p class="mb-0">${suggestion.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            container.appendChild(clothingCard);

            // Add Weather Widgets
            updateWeatherWidgets(data);

            // Add notifications for extreme conditions
            if (data.temperature > 30) {
                addNotification('High temperature alert! Stay hydrated and avoid prolonged sun exposure.', 'warning');
            } else if (data.temperature < 5) {
                addNotification('Low temperature alert! Dress warmly and be cautious of icy conditions.', 'warning');
            }
            if (data.wind_speed > 20) {
                addNotification('Strong winds detected. Secure outdoor objects and be cautious.', 'warning');
            }
            if (data.precipitation > 10) {
                addNotification('Heavy precipitation expected. Consider indoor activities.', 'info');
            }
        }

        async function compareCities(city1) {
            const city2 = document.getElementById('compareCity').value;
            if (!city2) {
                showError('Please enter a city to compare');
                return;
            }

            showLoading();
            try {
                const [data1, data2] = await Promise.all([
                    fetch(`/api/weather/current?city=${encodeURIComponent(city1)}`).then(res => res.json()),
                    fetch(`/api/weather/current?city=${encodeURIComponent(city2)}`).then(res => res.json())
                ]);

                const comparisonResults = document.getElementById('comparisonResults');
                comparisonResults.innerHTML = `
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>${city1}</th>
                                <th>${city2}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Temperature</td>
                                <td>${convertTemperature(data1.current.temperature, currentUnit).toFixed(1)}°${currentUnit === 'celsius' ? 'C' : 'F'}</td>
                                <td>${convertTemperature(data2.current.temperature, currentUnit).toFixed(1)}°${currentUnit === 'celsius' ? 'C' : 'F'}</td>
                            </tr>
                            <tr>
                                <td>Humidity</td>
                                <td>${data1.current.humidity}%</td>
                                <td>${data2.current.humidity}%</td>
                            </tr>
                            <tr>
                                <td>Wind Speed</td>
                                <td>${data1.current.wind_speed} m/s</td>
                                <td>${data2.current.wind_speed} m/s</td>
                            </tr>
                            <tr>
                                <td>Conditions</td>
                                <td>${data1.current.description}</td>
                                <td>${data2.current.description}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                hideLoading();
            } catch (error) {
                console.error('Error comparing cities:', error);
                showError('Error comparing cities. Please try again.');
                hideLoading();
            }
        }

        // Initialize the UI when the page loads
        document.addEventListener('DOMContentLoaded', initializeUI);

        // Add enter key support for search
        document.getElementById('cityInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                getWeather();
            }
        });
    </script>
</body>
</html> 